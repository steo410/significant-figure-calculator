<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>유효숫자 계산기</title>
<style>
body { font-family: Arial, sans-serif; padding:20px; }
.container { display:flex; gap:20px; }
.calc, .display { border:1px solid #ccc; padding:15px; width:380px; }
.buttons { display:grid; grid-template-columns:repeat(6,1fr); gap:6px; }
button { padding:10px; font-size:14px; }
.screen { font-size:18px; min-height:40px; border:1px solid #aaa; padding:5px; margin-bottom:10px; }
.popup { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); }
.popup-content { background:#fff; padding:20px; margin:120px auto; width:260px; text-align:center; }
</style>
</head>
<body>
<h1>유효숫자 계산기</h1>

<div class="container">
<div class="calc">
<div class="buttons">
<button onclick="clearAll()">C</button>
<button onclick="backspace()">←</button>
<button onclick="move(-1)">◀</button>
<button onclick="move(1)">▶</button>
<button onclick="input('(')">(</button>
<button onclick="input(')')">)</button>

<button onclick="inputFunc('sqrt')">√</button>
<button onclick="openRootPopup()">ⁿ√</button>
<button onclick="inputFunc('log')">log</button>
<button onclick="inputFunc('sin')">sin</button>
<button onclick="inputFunc('cos')">cos</button>
<button onclick="inputFunc('tan')">tan</button>

<button onclick="input('7')">7</button>
<button onclick="input('8')">8</button>
<button onclick="input('9')">9</button>
<button onclick="inputOp('/')">÷</button>
<button onclick="input('π')">π</button>
<button onclick="input('e')">e</button>

<button onclick="input('4')">4</button>
<button onclick="input('5')">5</button>
<button onclick="input('6')">6</button>
<button onclick="inputOp('*')">×</button>
<button onclick="input('^')">^</button>
<button onclick="input('1/(')">1/x</button>

<button onclick="input('1')">1</button>
<button onclick="input('2')">2</button>
<button onclick="input('3')">3</button>
<button onclick="inputOp('-')">−</button>
<button onclick="input('.')">.</button>
<button onclick="inputOp('+')">+</button>

<button onclick="input('0')">0</button>
<button onclick="calculate()" style="grid-column: span 5">=</button>
</div>
</div>

<div class="display">
<div class="screen" id="expr"></div>
<div class="screen" id="result"></div>
<div class="screen" style="font-size:14px; line-height:1.5" id="siginfo">
<b>유효숫자 계산 규칙</b><br>
• <b>유효숫자 개수</b>: 0이 아닌 숫자는 모두 유효숫자, 소수점 뒤의 0은 유효숫자<br>
• <b>정의된 수</b>(π, e, log(10ⁿ), 정수 계수)는 유효숫자에 영향 없음<br>
• <b>덧셈·뺄셈</b>: 소수점 자리 수가 가장 적은 값에 맞춰 반올림<br>
• <b>곱셈·나눗셈</b>: 유효숫자가 가장 적은 값에 맞춰 반올림<br>
• <b>함수(log, sin, √ 등)</b>: 입력값의 유효숫자를 그대로 따름<br>
• <b>반올림</b>: 계산 마지막 단계에서 한 번만 수행
</div>
</div>
</div>
</div>

<div class="popup" id="rootPopup">
<div class="popup-content">
<p>n 값 (정수)</p>
<input type="number" id="rootN" min="2" step="1" value="2">
<br><br>
<button onclick="confirmRoot()">확인</button>
<button onclick="closeRootPopup()">취소</button>
</div>
</div>

<script>
let expr='', cursor=0;

/* ===== 위첨자 ===== */
const sup={'0':'⁰','1':'¹','2':'²','3':'³','4':'⁴','5':'⁵','6':'⁶','7':'⁷','8':'⁸','9':'⁹'};
const rev=Object.fromEntries(Object.entries(sup).map(([k,v])=>[v,k]));
const toSup=n=>String(n).split('').map(d=>sup[d]).join('');
const fromSup=s=>s.split('').map(c=>rev[c]).join('');

/* ===== 유효숫자 ===== */
function sigFigs(t){
  if(t===undefined) return Infinity;
  if(t==='π'||t==='e') return Infinity;
  if(!t.includes('.')) return t.replace(/^0+|0+$/g,'').length;
  return t.replace(/^0+|\./g,'').length;
}

function roundSig(v,s){
  if(!isFinite(s)) return format(cleanZero(v));
  if(v===0) return '0';
  const e=Math.floor(Math.log10(Math.abs(v)));
  const f=Math.pow(10,s-1-e);
  const r=Math.round(v*f)/f;
  if(e>=s||e<=-3) return `${(r/10**e).toPrecision(s)}×10^${e}`;
  return r.toFixed(Math.max(0,s-1-e));
}

function format(v){
  const s=v.toString();
  if(s.includes('e')){
    const [m,e]=s.split('e');
    return `${Number(m)}×10^${Number(e)}`;
  }
  return s;
}
function cleanZero(v){ return Math.abs(v)<1e-12?0:v; }

/* ===== 특수각 삼각함수 (exact) ===== */
const TRIG_SPECIAL={
  sin:{'0':0,'π':0,'π/6':0.5,'π/4':Math.SQRT1_2,'π/3':Math.sqrt(3)/2,'π/2':1},
  cos:{'0':1,'π':-1,'π/6':Math.sqrt(3)/2,'π/4':Math.SQRT1_2,'π/3':0.5,'π/2':0},
  tan:{'0':0,'π':0,'π/6':1/Math.sqrt(3),'π/4':1,'π/3':Math.sqrt(3)}
};

function normAngle(x){ return x.replace(/\s+/g,'').replace('Math.PI','π'); }
function trig(func,x){
  const k=normAngle(x);
  if(TRIG_SPECIAL[func][k]!==undefined) return TRIG_SPECIAL[func][k];
  return cleanZero(Math[func](Function(`return ${x}`)()));
}

/* ===== 입력 ===== */
function render(){ document.getElementById('expr').innerText=expr.slice(0,cursor)+'|'+expr.slice(cursor); }
function input(v){ expr=expr.slice(0,cursor)+v+expr.slice(cursor); cursor+=v.length; render(); }
function inputOp(o){ input(` ${o} `); }
function inputFunc(f){ f==='sqrt'?input('√('):input(f+'('); }
function move(d){ cursor=Math.max(0,Math.min(expr.length,cursor+d)); render(); }
function backspace(){ if(cursor>0){ expr=expr.slice(0,cursor-1)+expr.slice(cursor); cursor--; render(); } }
function clearAll(){ expr=''; cursor=0; document.getElementById('expr').innerText=''; document.getElementById('result').innerText=''; }

function openRootPopup(){ document.getElementById('rootPopup').style.display='block'; }
function closeRootPopup(){ document.getElementById('rootPopup').style.display='none'; }
function confirmRoot(){ input(`${toSup(rootN.value)}√(`); closeRootPopup(); }

/* ===== 계산 (안정화) ===== */
function calculate(){
try{
  const tokens = expr.match(/(π|e|\d+\.?\d*)/g) || [];
  let minSig = Infinity;
  tokens.forEach(t=>{ minSig=Math.min(minSig,sigFigs(t)); });

  let safe = expr
    .replace(/([⁰¹²³⁴⁵⁶⁷⁸⁹]+)√\(([^)]+)\)/g,(_,n,x)=>`Math.pow(${x},1/${fromSup(n)})`)
    .replace(/√\(([^)]+)\)/g,(_,x)=>`Math.sqrt(${x})`)
    .replace(/log\(([^)]+)\)/g,(_,x)=>`Math.log10(${x})`)
    .replace(/sin\(([^)]+)\)/g,(_,x)=>`trig('sin','${x}')`)
    .replace(/cos\(([^)]+)\)/g,(_,x)=>`trig('cos','${x}')`)
    .replace(/tan\(([^)]+)\)/g,(_,x)=>`trig('tan','${x}')`)
    .replace(/π/g,'Math.PI')
    .replace(/e/g,'Math.E')
    .replace(/×/g,'*')
    .replace(/÷/g,'/')
    .replace(/\^/g,'**');

  const raw = Function('trig','Math',`return ${safe}`)(trig,Math);
  const result = roundSig(raw, minSig);
  document.getElementById('result').innerText = `= ${result}`;
}catch(err){
  document.getElementById('result').innerText = '계산 오류';
}}
render();
</script>
</body>
</html>
