<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>유효숫자 계산기</title>
<style>
body{font-family:Arial,sans-serif;padding:20px}
.container{display:flex;gap:20px}
.calc,.display{border:1px solid #ccc;padding:15px;width:380px}
.buttons{display:grid;grid-template-columns:repeat(6,1fr);gap:6px}
button{padding:10px;font-size:14px}
button.disabled{visibility:hidden}
.equal{grid-column:span 3;font-size:18px}
.screen{font-size:18px;min-height:40px;border:1px solid #aaa;padding:5px;margin-bottom:10px}
.popup{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4)}
.popup-content{background:#fff;padding:20px;margin:120px auto;width:260px;text-align:center}
.cursor{color:#888}
</style>
</head>

<body>
<h1>유효숫자 계산기</h1>

<div class="container">
<div class="calc">
<div class="buttons">

<button onclick="clearAll()">C</button>
<button onclick="backspace()">←</button>
<button onclick="move(-1)">◀</button>
<button onclick="move(1)">▶</button>
<button onclick="input('(')">(</button>
<button onclick="input(')')">)</button>

<button onclick="inputFunc('sqrt')">√</button>
<button onclick="openRootPopup()">ⁿ√</button>
<button onclick="inputFunc('log')">log</button>
<button onclick="inputFunc('sin')">sin</button>
<button onclick="inputFunc('cos')">cos</button>
<button onclick="inputFunc('tan')">tan</button>

<button onclick="input('7')">7</button>
<button onclick="input('8')">8</button>
<button onclick="input('9')">9</button>
<button onclick="input('1/(')">1/x</button>
<button onclick="input('π')">π</button>
<button onclick="input('e')">e</button>

<button onclick="input('4')">4</button>
<button onclick="input('5')">5</button>
<button onclick="input('6')">6</button>
<button onclick="inputOp('/')">÷</button>
<button onclick="inputOp('*')">×</button>
<button class="disabled"></button>

<button onclick="input('1')">1</button>
<button onclick="input('2')">2</button>
<button onclick="input('3')">3</button>
<button onclick="inputOp('+')">+</button>
<button onclick="inputOp('-')">−</button>
<button class="disabled"></button>

<button onclick="input('^')">^</button>
<button onclick="input('0')">0</button>
<button onclick="input('.')">.</button>
<button onclick="calculate()" class="equal">=</button>

</div>
</div>

<div class="display">
<div class="screen" id="expr"></div>
<div class="screen" id="result"></div>
<div class="screen" style="font-size:14px;line-height:1.5">
<b>유효숫자 계산 규칙</b><br>
• 덧셈·뺄셈: 소수점 자리 기준<br>
• 곱셈·나눗셈: 유효숫자 개수 기준<br>
• π, e 등 정의된 수는 유효숫자에 영향 없음<br>
• 반올림은 계산 마지막 단계에서 1회
</div>
</div>
</div>

<div class="popup" id="rootPopup">
<div class="popup-content">
<p>n 값 (정수)</p>
<input type="number" id="rootN" min="2" value="2">
<br><br>
<button onclick="confirmRoot()">확인</button>
<button onclick="closeRootPopup()">취소</button>
</div>
</div>

<script>
let expr='', cursor=0;

/* ===== 위첨자 ===== */
const sup={'0':'⁰','1':'¹','2':'²','3':'³','4':'⁴','5':'⁵','6':'⁶','7':'⁷','8':'⁸','9':'⁹'};
const rev=Object.fromEntries(Object.entries(sup).map(([k,v])=>[v,k]));
const toSup=n=>String(n).split('').map(d=>sup[d]).join('');
const fromSup=s=>s.split('').map(c=>rev[c]).join('');

/* ===== 화면 출력 ===== */
function render(){
  document.getElementById('expr').innerHTML =
    expr.slice(0,cursor) + '<span class="cursor">|</span>' + expr.slice(cursor);
}

/* ===== 입력 ===== */
function input(v){
  expr = expr.slice(0,cursor) + v + expr.slice(cursor);
  cursor += v.length;
  render();
}
function inputOp(o){ input(` ${o} `); }
function inputFunc(f){ f==='sqrt'?input('√('):input(f+'('); }
function move(d){
  cursor = Math.max(0, Math.min(expr.length, cursor + d));
  render();
}
function backspace(){
  if(cursor>0){
    expr = expr.slice(0,cursor-1) + expr.slice(cursor);
    cursor--;
    render();
  }
}
function clearAll(){
  expr=''; cursor=0; render(); result.innerText='';
}

/* ===== 루트 ===== */
function openRootPopup(){rootPopup.style.display='block'}
function closeRootPopup(){rootPopup.style.display='none'}
function confirmRoot(){input(`${toSup(rootN.value)}√(`);closeRootPopup()}

/* ===== 덧셈·뺄셈 ===== */
function sciAddSub(v, dec){
 if(v===0) return '0.0×10^0';
 const e=Math.floor(Math.log10(Math.abs(v)));
 let m=v/10**e;
 m=Math.round((m+Number.EPSILON)*10**dec)/10**dec;
 return m.toFixed(dec)+'×10^'+e;
}

/* ===== 곱셈·나눗셈 ===== */
function sciMulDiv(v, sig){
 if(v===0) return '0.0×10^0';
 const e=Math.floor(Math.log10(Math.abs(v)));
 const m=(v/10**e).toPrecision(sig);
 return m+'×10^'+e;
}

/* ===== 계산 (원본 그대로) ===== */
function calculate(){
 try{
  const nums=(expr.match(/\d+\.?\d*/g)||[]);
  const decs=nums.map(n=>n.includes('.')?n.split('.')[1].length:0);
  const sigs=nums.map(n=>n.replace('.','').replace(/^0+/,'').length);

  const minDec=Math.min(...decs);
  const minSig=Math.min(...sigs);

  let safe=expr
   .replace(/([⁰¹²³⁴⁵⁶⁷⁸⁹]+)√\(([^)]+)\)/g,(_,n,x)=>`Math.pow(${x},1/${fromSup(n)})`)
   .replace(/√\(/g,'Math.sqrt(')
   .replace(/sin\(/g,'Math.sin(')
   .replace(/cos\(/g,'Math.cos(')
   .replace(/tan\(/g,'Math.tan(')
   .replace(/log\(/g,'Math.log10(')
   .replace(/π/g,'Math.PI')
   .replace(/e/g,'Math.E')
   .replace(/×/g,'*').replace(/÷/g,'/')
   .replace(/\^/g,'**')
   .replace(/−/g,'-');

  const raw=Function(`return ${safe}`)();

  const out =
    expr.includes('+')||expr.includes('-')
      ? sciAddSub(raw,minDec)
      : sciMulDiv(raw,minSig);

  result.innerText='= '+out;
 }catch{
  result.innerText='계산 오류';
 }
}
render();
</script>
</body>
</html>
