<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>유효숫자 계산기</title>
<style>
body { font-family: Arial, sans-serif; padding:20px; }
.container { display:flex; gap:20px; }
.calc, .display { border:1px solid #ccc; padding:15px; width:380px; }
.buttons { display:grid; grid-template-columns:repeat(6,1fr); gap:6px; }
button { padding:10px; font-size:14px; }
.screen { font-size:18px; min-height:40px; border:1px solid #aaa; padding:5px; margin-bottom:10px; }
.info { font-size:14px; line-height:1.5; border:1px solid #ddd; padding:8px; }
.popup { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); }
.popup-content { background:#fff; padding:20px; margin:120px auto; width:260px; text-align:center; }
</style>
</head>

<body>
<h1>유효숫자 계산기</h1>

<div class="container">
<div class="calc">
<div class="buttons">
<button onclick="clearAll()">C</button>
<button onclick="backspace()">←</button>
<button onclick="move(-1)">◀</button>
<button onclick="move(1)">▶</button>
<button onclick="input('(')">(</button>
<button onclick="input(')')">)</button>

<button onclick="inputFunc('sqrt')">√</button>
<button onclick="openRootPopup()">ⁿ√</button>
<button onclick="inputFunc('log')">log</button>
<button onclick="inputFunc('sin')">sin</button>
<button onclick="inputFunc('cos')">cos</button>
<button onclick="inputFunc('tan')">tan</button>

<button onclick="input('7')">7</button>
<button onclick="input('8')">8</button>
<button onclick="input('9')">9</button>
<button onclick="inputOp('/')">÷</button>
<button onclick="input('π')">π</button>
<button onclick="input('e')">e</button>

<button onclick="input('4')">4</button>
<button onclick="input('5')">5</button>
<button onclick="input('6')">6</button>
<button onclick="inputOp('*')">×</button>
<button onclick="input('^')">^</button>
<button onclick="input('1/(')">1/x</button>

<button onclick="input('1')">1</button>
<button onclick="input('2')">2</button>
<button onclick="input('3')">3</button>
<button onclick="inputOp('-')">−</button>
<button onclick="input('.')">.</button>
<button onclick="inputOp('+')">+</button>

<button onclick="input('0')">0</button>
<button onclick="calculate()" style="grid-column: span 5">=</button>
</div>
</div>

<div class="display">
<div class="screen" id="expr"></div>
<div class="screen" id="result"></div>

<div class="info">
<b>유효숫자 계산 규칙</b><br>
• 정의된 수(π, e, sin, log 등)는 유효숫자에 영향 없음<br>
• 덧셈·뺄셈: 소수점 자리 수 기준<br>
• 곱셈·나눗셈: 유효숫자 개수 기준<br>
• 함수값: 입력된 측정값의 유효숫자 유지<br>
• 반올림은 계산 마지막 단계에서 1회
</div>
</div>
</div>

<div class="popup" id="rootPopup">
<div class="popup-content">
<p>n 값 (정수)</p>
<input type="number" id="rootN" min="2" value="2">
<br><br>
<button onclick="confirmRoot()">확인</button>
<button onclick="closeRootPopup()">취소</button>
</div>
</div>

<script>
let expr='', cursor=0;

/* 위첨자 */
const sup={'0':'⁰','1':'¹','2':'²','3':'³','4':'⁴','5':'⁵','6':'⁶','7':'⁷','8':'⁸','9':'⁹'};
const rev=Object.fromEntries(Object.entries(sup).map(([k,v])=>[v,k]));
const toSup=n=>String(n).split('').map(d=>sup[d]).join('');
const fromSup=s=>s.split('').map(c=>rev[c]).join('');

/* 유효숫자 */
function sigFigs(t){
  if(!t || t==='π' || t==='e') return Infinity;
  if(!t.includes('.')) return t.replace(/^0+|0+$/g,'').length;
  return t.replace(/^0+|\./g,'').length;
}

/* 항상 n.abcd × 10^m */
function roundSig(v, s){
  if(!isFinite(v)) return '오류';
  if(v === 0) return '0.00 × 10^0';

if(!isFinite(s)){
  const e = Math.floor(Math.log10(Math.abs(v||1)));
  const m = (v / 10**e).toString();
  return `${m} × 10^${e}`;
}


  const expStr = v.toExponential(s - 1); 
  const [mant, exp] = expStr.split('e');

  // mant는 문자열 그대로 유지 (중요!)
  return `${mant} × 10^${Number(exp)}`;
}


/* 삼각함수 특수각 */
function trig(func,val){
  const eps=1e-12;
  if(Math.abs(val-Math.PI/4)<eps){
    if(func==='tan') return 1;
    return Math.SQRT1_2;
  }
  if(Math.abs(val-Math.PI)<eps){
    if(func==='cos') return -1;
    return 0;
  }
  return Math[func](val);
}

/* 입력 */
function render(){ document.getElementById('expr').innerText=expr.slice(0,cursor)+'|'+expr.slice(cursor); }
function input(v){ expr=expr.slice(0,cursor)+v+expr.slice(cursor); cursor+=v.length; render(); }
function inputOp(o){ input(` ${o} `); }
function inputFunc(f){ f==='sqrt'?input('√('):input(f+'('); }
function move(d){ cursor=Math.max(0,Math.min(expr.length,cursor+d)); render(); }
function backspace(){ if(cursor>0){ expr=expr.slice(0,cursor-1)+expr.slice(cursor); cursor--; render(); } }
function clearAll(){ expr=''; cursor=0; document.getElementById('expr').innerText=''; document.getElementById('result').innerText=''; }

function openRootPopup(){ document.getElementById('rootPopup').style.display='block'; }
function closeRootPopup(){ document.getElementById('rootPopup').style.display='none'; }
function confirmRoot(){
  const n=document.getElementById('rootN').value;
  input(`${toSup(n)}√(`);
  closeRootPopup();
}

/* 계산 */
function calculate(){
try{
  const cleaned = expr.replace(/(sin|cos|tan|log|√|\([^)]+\))/g,'');
  const nums = cleaned.match(/(\d+\.?\d*)/g)||[];
  let minSig=Infinity;
  nums.forEach(n=>minSig=Math.min(minSig,sigFigs(n)));

  let safe=expr
    .replace(/([⁰¹²³⁴⁵⁶⁷⁸⁹]+)√\(([^)]+)\)/g,(_,n,x)=>`Math.pow(${x},1/${fromSup(n)})`)
    .replace(/√\(([^)]+)\)/g,(_,x)=>`Math.sqrt(${x})`)
    .replace(/log\(([^)]+)\)/g,(_,x)=>`Math.log10(${x})`)
    .replace(/sin\(([^)]+)\)/g,(_,x)=>`trig('sin',(${x}))`)
    .replace(/cos\(([^)]+)\)/g,(_,x)=>`trig('cos',(${x}))`)
    .replace(/tan\(([^)]+)\)/g,(_,x)=>`trig('tan',(${x}))`)
    .replace(/π/g,'Math.PI')
    .replace(/e/g,'Math.E')
    .replace(/×/g,'*')
    .replace(/÷/g,'/')
    .replace(/\^/g,'**');

  const raw=Function('trig','Math',`return ${safe}`)(trig,Math);
  document.getElementById('result').innerText='= '+roundSig(raw,minSig);
}catch{
  document.getElementById('result').innerText='계산 오류';
}}
render();
</script>
</body>
</html>
